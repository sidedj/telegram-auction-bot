# Автоматическая система обработки платежей

## Обзор

Автоматическая система обработки платежей решает проблему с большим количеством пользователей, обеспечивая автоматическое зачисление средств без ручного вмешательства.

## Компоненты системы

### 1. YooMoneyAPI (`yoomoney_api.py`)
- Работа с API ЮMoney
- Получение истории операций
- Проверка подписей webhook'ов

### 2. PaymentProcessor (`payment_processor.py`)
- Обработка платежей из webhook'ов
- Обработка ожидающих платежей
- Интеграция с базой данных

### 3. AutomaticPaymentSystem (`payment_processor.py`)
- Автоматическая проверка платежей каждые 5 минут
- Фоновая обработка
- Управление состоянием системы

## Как работает система

### 1. Автоматический режим
- Система запускается при старте бота
- Каждые 5 минут проверяет новые платежи в ЮMoney
- Автоматически зачисляет средства пользователям
- Логирует все операции

### 2. Ручной режим
- Команды для принудительной обработки
- Проверка статуса платежей
- Управление системой

## Команды для администраторов

### Управление автоматической системой

#### `/auto_payments start`
Запускает автоматическую систему обработки платежей
```
/auto_payments start
```

#### `/auto_payments stop`
Останавливает автоматическую систему
```
/auto_payments stop
```

#### `/auto_payments status`
Показывает статус системы
```
/auto_payments status
```

### Обработка платежей

#### `/process_payment <operation_id>`
Принудительно обрабатывает платеж по ID операции
```
/process_payment 81046042603529710
```

#### `/check_payment <operation_id>`
Проверяет статус платежа
```
/check_payment 81046042603529710
```

#### `/manual_payment <user_id> <amount> <description>`
Зачисляет средства вручную
```
/manual_payment 7647551803 1 Ручное пополнение за 50 руб
```

## Настройка

### 1. Конфигурация
Настройки в `config.py`:
```python
YOOMONEY_RECEIVER = "4100118987681575"
YOOMONEY_SECRET = "SaTKEuJWPVXJI/JFpXDCHZ4q"
DATABASE_PATH = "auction_bot.db"
```

### 2. Запуск
Система запускается автоматически при старте бота:
```python
# В main() функции
payment_task = asyncio.create_task(payment_system.start())
```

## Мониторинг

### Логи
Все операции логируются с уровнем INFO:
- Запуск/остановка системы
- Обработка платежей
- Ошибки API
- Статистика обработки

### Команды мониторинга
- `/sync_payments` - последние обработанные платежи
- `/auto_payments status` - статус системы
- `/check_payment` - проверка конкретного платежа

## Преимущества

### 1. Масштабируемость
- Обрабатывает любое количество пользователей
- Работает в фоне без вмешательства
- Автоматическое восстановление при ошибках

### 2. Надежность
- Проверка дублирования платежей
- Обработка ошибок API
- Логирование всех операций

### 3. Гибкость
- Ручное управление при необходимости
- Принудительная обработка платежей
- Мониторинг в реальном времени

## Устранение неполадок

### Система не обрабатывает платежи
1. Проверьте статус: `/auto_payments status`
2. Перезапустите систему: `/auto_payments stop` → `/auto_payments start`
3. Проверьте логи на ошибки

### Платеж не найден
1. Используйте `/process_payment <operation_id>`
2. Проверьте правильность ID операции
3. Убедитесь, что платеж прошел в ЮMoney

### Ошибки API
1. Проверьте настройки в `config.py`
2. Убедитесь, что API ЮMoney доступен
3. Проверьте логи для деталей ошибки

## Тестирование

### Тест системы
```bash
python test_automatic_payments.py
```

### Тест одного платежа
```python
from payment_processor import payment_system
success = await payment_system.process_single_payment("operation_id")
```

## Статистика

Система ведет статистику:
- Количество обработанных платежей
- Время последней проверки
- Статус подключения к API
- Ошибки и предупреждения

## Безопасность

### Проверка подписей
- Все webhook'и проверяются на подлинность
- Используется HMAC-SHA1 для проверки

### Защита от дублирования
- Отслеживание обработанных платежей
- Проверка по `operation_id`

### Логирование
- Все операции записываются в логи
- Аудит действий администраторов
- Мониторинг ошибок

## Производительность

### Оптимизация
- Проверка только новых платежей
- Кэширование результатов API
- Асинхронная обработка

### Масштабирование
- Обработка до 1000+ пользователей
- Параллельная обработка платежей
- Автоматическое восстановление

## Заключение

Автоматическая система обработки платежей обеспечивает:
- ✅ Полную автоматизацию для большого количества пользователей
- ✅ Надежную обработку без потери платежей
- ✅ Гибкое управление и мониторинг
- ✅ Масштабируемость и производительность
